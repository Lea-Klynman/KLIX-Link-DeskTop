<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <title>KLIX-Link-DeskTop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #eef2f5;
            padding: 2rem;
            direction: rtl;
            font-family: 'Arial', sans-serif;
        }
        .container {
            max-width: 800px;
            margin: auto;
        }
        h1 {
            color: #6fa8cb;
            font-size: 2rem;
            text-align: center;
            margin-bottom: 30px;
        }
        #content {
            margin-top: 30px;
            padding: 20px;
            background: #fff;
            border-radius: 12px;
            min-height: 300px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden; /* make sure everything fits */
        }
        .form-label {
            font-weight: bold;
            color: #70ab9f;
        }
        .btn {
            background-color: #74ad7d;
            border-color: #74ad7d;
            color: white;
        }
        .btn:hover {
            background-color: #6fa8cb;
            border-color: #6fa8cb;
        }
        .alert {
            font-weight: bold;
        }
        .alert-warning {
            background-color: #ffe066;
            color: #856404;
        }
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
        }
        canvas {
            width: 100% !important; /* ensures the canvas fits the width of the container */
            height: auto !important; /* keeps the aspect ratio of the canvas */
            display: block; /* makes sure it is treated as a block element */
            margin: 0 auto; /* centers the canvas */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>KLIX-Link-DeskTop</h1>

        <div class="mb-3">
            <label for="upload" class="form-label">בחר קובץ מוצפן (DOCX או PDF)</label>
            <input type="file" id="upload" class="form-control" accept=".docx,.pdf">
        </div>

        <div id="content">
            <p class="text-muted text-center">No Chosen File </p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script>
        async function decryptFile(buffer, keyStr) {
            const iv = new Uint8Array(16); // zero IV
            const encoder = new TextEncoder();
            const keyBuffer = encoder.encode(keyStr.padEnd(32, ' ')).slice(0, 32);

            const cryptoKey = await crypto.subtle.importKey(
                "raw",
                keyBuffer,
                { name: "AES-CBC" },
                false,
                ["decrypt"]
            );

            const decrypted = await crypto.subtle.decrypt(
                { name: "AES-CBC", iv: iv },
                cryptoKey,
                buffer
            );

            return new Uint8Array(decrypted);
        }

        function arrayBufferToBlob(buffer, type) {
            return new Blob([buffer], { type });
        }

        function displayPDF(buffer) {
            const contentEl = document.getElementById("content");
            const loadingTask = pdfjsLib.getDocument({data: buffer});
            loadingTask.promise.then(pdf => {
                const viewer = document.createElement("div");
                viewer.style.width = '100%';
                viewer.style.height = 'auto';
                contentEl.innerHTML = ""; // Clear previous content
                contentEl.appendChild(viewer);

                function renderPage(pageNum) {
                    pdf.getPage(pageNum).then(function(page) {
                        const canvas = document.createElement("canvas");
                        const context = canvas.getContext('2d');
                        const scale = 1.5; // adjust the scale here if necessary
                        const viewport = page.getViewport({ scale: scale });

                        canvas.height = viewport.height;
                        canvas.width = viewport.width;

                        page.render({
                            canvasContext: context,
                            viewport: viewport
                        }).promise.then(() => {
                            viewer.appendChild(canvas);
                            if (pageNum < pdf.numPages) {
                                renderPage(pageNum + 1);
                            }
                        });
                    });
                }

                renderPage(1);
            }).catch(error => {
                console.error("Error loading PDF:", error);
            });
        }

        document.getElementById("upload").addEventListener("change", async function () {
            const file = this.files[0];
            const key = "12345671234@KLIXLINK@12345671234";
            const contentEl = document.getElementById("content");

            if (!file || !key) {
                alert("אנא הזן מפתח ובחר קובץ");
                return;
            }

            try {
                const arrayBuffer = await file.arrayBuffer();
                const decrypted = await decryptFile(arrayBuffer, key);

                const ext = file.name.split('.').pop().toLowerCase();

                if (ext === "pdf") {
                    const blob = arrayBufferToBlob(decrypted, "application/pdf");
                    const url = URL.createObjectURL(blob);

                    displayPDF(decrypted); // Display the decrypted PDF
                } else {
                    contentEl.innerHTML = `
                        <div class="alert alert-warning text-center">
                            תצוגת DOCX לא נתמכת בדפדפן זה. השתמשי בגרסת Electron עם פענוח צד שרת.
                        </div>`;
                }
            } catch (e) {
                contentEl.innerHTML = `
                    <div class="alert alert-danger text-center">
                        שגיאה בפענוח הקובץ: ${e.message}
                    </div>`;
            }
        });
    </script> 
</body>
</html>

